今天开始正式设置 https://rust-lang.cc 的仓库和同步。

主仓库：  
https://gitee.com/maozhonggui/rust-lang.cc  

gitlab 同步仓库(从 gitee pull)  
https://gitlab.com/jackymao/rust-lang.cc  

gitlab 同步到 github 仓库 ( gitlab push to github)  
https://github.com/rust-lang-cc/rust-lang.cc  

三个都是 private 仓库。

首先要确定这三个仓库能全部同步。  
同步方向： gitee --> gitlab --> github  

然后再按照 fly.io 的 github 设置，每次有代码更新到了 github, 用 github action 编译并推送到 fly.io (在 fly.io 已经设置好 https://rust-lang.cc )， 这样就可以在线上直接看到更新了。

如果上面两项都没有问题，那么，以后在本地更新代码，git add . && git commit -m "update" && git push 到 gitee 之后，会自动同步到 gitlab 再自动到 github 再自动到 fly.io. 除了 git push 到 gitee 是实时的，后面的步骤可以要花约一天的时间自动同步，就不强求时效了。(有个页面说的是如果成功的 pull 之后，下一次的更新会有至少 30分钟了间隔了。  https://docs.gitlab.com/ee/user/project/repository/repository_mirroring.html#how-it-works  ) (看这个页面， pull repository 是一个 primium 了，不知道会不会这个功能普通用户不能用了哦。)  
Repository mirrors are updated as Sidekiq becomes available to process them. If the process of updating the repository mirror:  
Succeeds: An update is enqueued again with at least a 30 minute wait.
Fails: (For example, a branch diverged from upstream.), The update attempted again later. Mirrors can fail up to 14 times before they are no longer enqueued for updates  

https://forum.gitlab.com/t/pull-based-mirroring-from-github-for-ci-is-no-longer-mirrored/35724/26
有可能改为 public 就可以。要试试确定一下。  
将 gitlab 上的这个改为 public 之后，可以在 mirroring 页面选择 pull 了。 pull 的源头 gitee 上的 repo 还是不公开的。 而 github 上的 push 本来在 gitlab 不是 public 的时候都能推送。  
所以现在在本文件最开始写的 三个仓库都是 private， 现在是其中的 gitlab 要是 public, 才能免费 pull. 
 
今天增加了这个 20210801.md 文件，看到明天这个时候能不能同步到 gitlab 和 github. (github 上还没设置 fly.io ，就还不会同步到 fly.io).

2021-08-01 23:05  
现在看到 gitlab 已经从 gitee pull 了，已经 push 到 github，然后 github 已经用 action 推送到 fly.io.  
现在访问 https://rust-lang.cc 已经是新的内容了。  

以后如果需要 gitlab 的仓库改为不公开， gitlab 要么要收钱改为 silver 用户(brozon好像是能 pull 不能 ci)。  
要么就手工同时 push 到 gitee 和 gitlab, 然后后续的 push 到 github 和后续 github 到 fly.io 的流程是没有问题的。


现在要关注的问题就是，目前是用的 fly.io 的 static 模板部署的，要改为用 rust ，我要用 trillium， 参考：  
https://github.com/fly-apps/hello-rust  
这里用的是 warp ，但没有问题， 我应该只是需要用它的 Dockerfile, .dockerignore, .gitignore, fly.toml( 而这个 fly.toml 里面有一个 cmd 要改 )， 其它的 rust 文件的功能，我自己能搞定。  




2021-08-01 21：03  
刚看到 README.md 文件成功同步到 github 了，邮箱就收到一封邮件，说用地址里面含用户名密码的方式在 2021-08-13 之后不能再用了，要转换为用 token 的方式。不过gitlab 好像还没有用 token 做 mirror push 的设置呢。有点难办。  

https://github.blog/2020-12-15-token-authentication-requirements-for-git-operations/
In July 2020, we announced our intent to require the use of token-based authentication (for example, a personal access, OAuth, or GitHub App installation token) for all authenticated Git operations. Beginning August 13, 2021, we will no longer accept account passwords when authenticating Git operations on GitHub.com.  


https://docs.gitlab.com/ee/user/project/repository/repository_mirroring.html#ssh-authentication  
repository_mirroring ssh-authentication

在 gitlab 重新加一个 mirroring ，地址填 github 的 ssh 地址，然后删除了原 https 同步。 然后可以看到新加的 ssh mirroring 后面有一个点击复制 ssh key 的按钮，点了之后，到 github 的后台增加这个 deploy key.

现在开始专心搞 github action 以在更新的时候自动编译并同步到 fly.io  
https://fly.io/docs/app-guides/continuous-deployment-with-github-actions  
FLY_API_TOKEN  
ALSB01fkue1_QEBmx80M5xVl7G6XmtwVj2FWiUeAy-s  

.github/workflows/main.yml

```yml
name: Fly Deploy
on: [push]
env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
jobs:
  deploy:
      name: Deploy app
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - uses: superfly/flyctl-actions@1.1
          with:
            args: "deploy"
```